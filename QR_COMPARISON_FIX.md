# Room Code vs Tile QR Scanning Issue - Analysis & Fix

## Problem Description

**Works:** Room code QR scanning (join room page)
**Doesn't Work:** Tile QR scanning (in-game)

Both use the same `QRScanner` component, but scanning behavior differs.

---

## Root Cause Analysis

### Differences Between Room Code QR and Tile QR:

| Feature | Room Code QR | Tile QR |
|---------|--------------|---------|
| **Data Format** | URL: `https://...?code=123456` | JSON: `{"type":"tile","position":5}` |
| **Data Size** | ~50 characters | ~35 characters |
| **Complexity** | URL string | JSON string |
| **Error Correction** | None specified | **Was: None → Now: HIGH** |
| **Usage Context** | Join page (fresh scanner) | Game page (after other interactions) |

### Key Issues Identified:

1. **Error Correction Level Missing**
   - Room QR codes generated by external sources may have higher error correction
   - Tile QR codes were generated with NO error correction setting
   - **Fix:** Added `errorCorrectionLevel: 'H'` to QRCodeDisplay

2. **Scanner Not Optimized for JSON Content**
   - JSON strings with special characters (`{`, `}`, `:`, `"`) are harder to decode
   - Mobile cameras may struggle with focus on smaller patterns
   - **Fix:** Added experimental barcode detector feature

3. **Scanning Context**
   - Room code: Fresh page load, scanner initializes cleanly
   - Tile QR: Scanner opens/closes multiple times during game
   - Possible camera resource conflicts

---

## Fixes Applied

### 1. QRCodeDisplay.tsx - Higher Error Correction

```typescript
errorCorrectionLevel: 'H' // High error correction (30% redundancy)
```

**Impact:**
- Makes QR codes more resilient to damage/blur
- Easier to scan at angles or in poor lighting
- Slightly larger QR code pattern (more data redundancy)

### 2. QRScanner.tsx - Better Detection

```typescript
experimentalFeatures: {
  useBarCodeDetectorIfSupported: true // Use native API if available
}
```

**Impact:**
- Uses native device barcode detector when available
- Faster and more accurate scanning
- Better support for JSON and special characters

### 3. Scanning Configuration Improvements

```typescript
fps: 10              // Scan 10 times per second
qrbox: 250          // Scanning area size
disableFlip: false  // Allow scanning from any angle
aspectRatio: 1.0    // Square aspect for stability
```

---

## Testing Guide

### Test 1: Generate New Tile QR Codes

1. Go to `/tiles` page
2. Generate tiles with new HIGH error correction
3. Download and print
4. Test scanning on mobile

**Expected:** Should scan much easier now

### Test 2: Existing Tile QR Codes

If you have old QR codes (without high error correction):

**Workarounds:**
- Print at **larger size** (minimum 3x3 inches)
- Ensure **good lighting** when scanning
- Hold phone **closer** (15-20cm distance)
- Keep phone **very steady** for 2-3 seconds
- Clean your camera lens

### Test 3: Side-by-Side Comparison

1. **Room Code QR:** Go to join room page, scan a room QR
2. **Tile QR:** Start game, roll dice, scan a tile QR
3. Compare scanning speed and accuracy

**Expected After Fix:**
- Both should scan within 1-2 seconds
- Both should work in similar lighting conditions

---

## Why Room Code QR Works Better (Before Fix)

1. **URL Format**
   - URLs are simple ASCII text
   - No special JSON characters to decode
   - Most QR generators default to medium-high error correction for URLs

2. **External Generation**
   - Room code QRs might be generated by:
     - Website QR generators (default to high error correction)
     - QR code apps (optimize for scanning)
   - Tile QRs were generated in-app with basic settings

3. **User Expectation**
   - Users scan room QRs once, carefully
   - Users scan tile QRs repeatedly, quickly during gameplay
   - Higher chance of rushed scanning causing issues

---

## Additional Mobile-Specific Issues

### Camera Permissions
Both use the same camera, so permissions are identical.

### Resource Cleanup
**Potential Issue:** Scanner not cleaning up properly between scans

**Check:**
```typescript
// In QRScanner.tsx - cleanup is handled:
return () => {
  if (scannerRef.current?.isScanning) {
    scannerRef.current.stop().then(() => {
      scannerRef.current?.clear();
    }).catch(console.error);
  }
};
```

✅ This is properly implemented

### Multiple Scanner Instances
**Potential Issue:** Opening scanner multiple times in same session

**Solution:** The component properly cleans up on unmount, so this shouldn't be an issue.

---

## Recommendations

### For Immediate Use:

1. **Regenerate All Tile QR Codes**
   - Use the `/tiles` page to generate new QR codes
   - New codes will have HIGH error correction
   - Download and replace old tiles

2. **Print Quality Matters**
   - Use **high-quality printer** (300 DPI minimum)
   - Print on **white cardstock** or photo paper
   - Ensure **high contrast** (black on white)
   - Laminate tiles to prevent wear

3. **Optimal Tile Size**
   - Minimum: **3x3 inches** (7.5cm x 7.5cm)
   - Recommended: **4x4 inches** (10cm x 10cm) for easy scanning
   - Larger is better for fast-paced gameplay

### For QR Code Testing:

Test your QR codes at:
- https://qrcode.tec-it.com/en/reader (webcam test)
- https://webqr.com/ (upload test)

Both should decode your JSON string successfully.

---

## Troubleshooting Steps

If tile QR codes still don't scan:

### Step 1: Verify QR Code Content

Use an online QR reader to check what's in the QR code:
- Expected: `{"type":"tile","position":5}`
- If different, regenerate the tiles

### Step 2: Check Lighting

- **Too bright:** Glare on laminated surface
- **Too dark:** Camera can't focus
- **Optimal:** Indirect bright light (no direct glare)

### Step 3: Test Print Quality

- QR should be **crisp and clear**
- No blurry edges or ink bleeding
- High contrast black and white
- No wrinkles or folds

### Step 4: Camera Focus

Mobile camera issues:
1. Clean lens with soft cloth
2. Tap screen to force focus
3. Move QR closer/further to find focus point
4. Hold steady for 2-3 seconds

### Step 5: Browser/Device Test

Try different combinations:
- **iOS Safari** (best support)
- **Android Chrome** (good support)
- **Different device** (eliminate hardware issue)

---

## Technical Comparison

### Error Correction Levels:

| Level | Error Tolerance | Best For |
|-------|-----------------|----------|
| L | 7% | Simple text, perfect conditions |
| M | 15% | General use |
| Q | 25% | Outdoor use, slight damage OK |
| **H** | **30%** | **Gameplay, repeated scanning** |

**Our Choice:** H (High) - Best for repeated gameplay scanning

### QR Code Size Calculation:

For JSON `{"type":"tile","position":99}`:
- Characters: 32
- With error correction H: ~40% more data
- Recommended modules: 29x29 minimum
- Print size: 3+ inches for easy scanning

---

## Comparison Test Results (Expected)

### Before Fix:
- Room Code QR: ✅ Scans in 1-2 seconds
- Tile QR: ❌ Takes 5+ seconds or fails

### After Fix:
- Room Code QR: ✅ Scans in 1-2 seconds
- Tile QR: ✅ Scans in 1-2 seconds

---

## Long-term Solutions

### Option 1: Simplify Tile Data (Alternative)

Instead of JSON, use simple format:
```javascript
// Current: {"type":"tile","position":5}
// Alternative: TILE:5 or just 5
```

**Pros:**
- Smaller QR code
- Faster scanning
- Less error-prone

**Cons:**
- Need to update parsing logic

### Option 2: Use URL Format (Like Room Codes)

Generate tile QR as URL:
```
https://yourdomain.com/tile?pos=5
```

**Pros:**
- Same format as room codes
- Works with most QR readers
- Can open directly in browser

**Cons:**
- Larger QR code
- Requires URL parsing

### Option 3: Use Numeric IDs Only

Simplest approach:
```javascript
// QR contains: "5"
// Parse as: tile position 5
```

**Pros:**
- Smallest QR code
- Fastest scanning
- Universal compatibility

**Cons:**
- Less context (no type checking)

---

## Summary

**Changes Made:**
1. ✅ Added HIGH error correction to QRCodeDisplay
2. ✅ Enabled experimental barcode detector in QRScanner
3. ✅ Improved scanning configuration

**Action Required:**
1. **Regenerate tile QR codes** from `/tiles` page
2. **Test scanning** on mobile device
3. **Replace old printed tiles** with new ones

**Expected Outcome:**
Tile QR codes should now scan as easily as room code QR codes on mobile devices.
